# Example policy configuration for GCP IAM Emulator
# Load with: server --config policy.yaml

# Groups (v0.3.0+): Define reusable groups of principals
groups:
  developers:
    members:
      - user:alice@example.com
      - user:bob@example.com
      - serviceAccount:dev-bot@test-project.iam.gserviceaccount.com
  
  operators:
    members:
      - user:ops@example.com
      - group:oncall  # Nested group (1 level supported)
  
  oncall:
    members:
      - user:charlie@example.com
      - user:diana@example.com

projects:
  test-project:
    # Project-level bindings (inherited by all resources)
    bindings:
      - role: roles/owner
        members:
          - user:admin@example.com
      
      - role: roles/viewer
        members:
          - group:developers  # Group reference (v0.3.0+)
          - serviceAccount:readonly@test-project.iam.gserviceaccount.com
      
      # Conditional binding (v0.3.0+): CI can only access production secrets
      - role: roles/secretmanager.secretAccessor
        members:
          - serviceAccount:ci@test-project.iam.gserviceaccount.com
        condition:
          expression: 'resource.name.startsWith("projects/test-project/secrets/prod-")'
          title: "Production secrets only"
          description: "CI service account restricted to production secrets"
      
      # Time-based access (v0.3.0+): Temporary access expires at end of year
      - role: roles/cloudkms.cryptoKeyEncrypterDecrypter
        members:
          - serviceAccount:temp-access@test-project.iam.gserviceaccount.com
        condition:
          expression: 'request.time < timestamp("2026-12-31T23:59:59Z")'
          title: "Temporary access"
          description: "Access expires December 31, 2026"
    
    # Optional: Audit logging configuration (v0.3.0+)
    auditConfigs:
      - service: secretmanager.googleapis.com
        auditLogConfigs:
          - logType: ADMIN_READ
          - logType: DATA_READ
          - logType: DATA_WRITE
            exemptedMembers:
              - serviceAccount:logging@test-project.iam.gserviceaccount.com
    
    # Resource-specific overrides
    resources:
      secrets/db-password:
        bindings:
          - role: roles/secretmanager.secretAccessor
            members:
              - serviceAccount:app@test-project.iam.gserviceaccount.com
      
      secrets/api-key:
        bindings:
          # Resource type condition (v0.3.0+)
          - role: roles/secretmanager.admin
            members:
              - user:admin@example.com
            condition:
              expression: 'resource.type == "SECRET"'
              title: "Secrets only"
      
      locations/global/keyRings/prod-keys/cryptoKeys/encryption-key:
        bindings:
          - role: roles/cloudkms.cryptoKeyEncrypterDecrypter
            members:
              - serviceAccount:app@test-project.iam.gserviceaccount.com

  staging-project:
    bindings:
      - role: roles/editor
        members:
          - user:dev@example.com
      
      - role: roles/secretmanager.secretAccessor
        members:
          - allAuthenticatedUsers

# Supported roles:
# - roles/owner (all permissions)
# - roles/editor (read/write, no IAM)
# - roles/viewer (read-only)
# - roles/secretmanager.admin (full Secret Manager)
# - roles/secretmanager.secretAccessor (read secrets only)
# - roles/cloudkms.admin (full KMS)
# - roles/cloudkms.cryptoKeyEncrypterDecrypter (encrypt/decrypt only)

# Supported member formats:
# - user:email@example.com
# - serviceAccount:name@project.iam.gserviceaccount.com
# - group:group-name (v0.3.0+)
# - allUsers
# - allAuthenticatedUsers

# Resource hierarchy resolution:
# The emulator checks policies in this order:
# 1. Exact resource match (e.g., projects/test/secrets/db-password)
# 2. Parent resources (e.g., projects/test)
# 3. First match wins
